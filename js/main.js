function loadMap(){vmodel.map=new google.maps.Map(document.getElementById("map_container"),{center:vmodel.currentLocation().latlong,zoom:15}),vmodel.geocoder=new google.maps.Geocoder,vmodel.infowindow=new google.maps.InfoWindow,vmodel.service=new google.maps.places.PlacesService(vmodel.map),vmodel.distanceService=new google.maps.DistanceMatrixService,vmodel.streetViewService=new google.maps.StreetViewService,vmodel.address(locationData.address),vmodel.city(locationData.city),vmodel.state(locationData.state),vmodel.newLocation()}var locationData={address:"289 Watch Hill Rd",city:"Exton",state:"PA"},Location=function(i,e,t){this.address=i,this.city=e,this.state=t,this.formatted_address=i+", "+e+", "+t,this.facilityCategoryList=[],this.init()};Location.prototype.init=function(){this.facilityCategoryList.push(new FacilityCategory("All","all")),this.facilityCategoryList.push(new FacilityCategory("Hospitals","hospital")),this.facilityCategoryList.push(new FacilityCategory("Fitness/gym/sports","gym")),this.facilityCategoryList.push(new FacilityCategory("Food","restaurant")),this.facilityCategoryList.push(new FacilityCategory("Mall","shopping_mall")),this.facilityCategoryList.push(new FacilityCategory("Schools","school")),this.facilityCategoryList.push(new FacilityCategory("Public Transit","transit_station")),this.facilityCategoryList.push(new FacilityCategory("Groceries","convenience_store")),this.facilityCategoryList.push(new FacilityCategory("Mailing Services","post_office")),this.facilityCategoryList.push(new FacilityCategory("Veterinary","veterinary_care")),this.facilityCategoryList.push(new FacilityCategory("Pet Shops","pet_store"))};var FacilityCategory=function(i,e){var t=this;this.type=i,this.key=e,this.facilities=ko.observableArray([]),this.numOfFacilities=ko.computed(function(){return t.facilities().length})},Facility=function(i,e){this.name=i.name,this.location=i.geometry.location,this.placeid=i.place_id,this.marker=e},ViewModel=function(){var i=this;this.currentLocation=ko.observable(),this.currentFacilityList=ko.observable(),this.address=ko.observable(),this.city=ko.observable(),this.state=ko.observable(),this.locationMarker=null,this.validated=ko.computed(function(){return!!(i.address()&&i.address().trim()&&i.city()&&i.city().trim()&&i.state()&&i.state().trim())}),this.currentFacilityList.subscribe(function(){i.filterMarkers()}),this.init=function(){this.currentLocation(new Location(locationData.address,locationData.city,locationData.state)),this.currentFacilityList(this.currentLocation().facilityCategoryList[0]),this.address.extend({required:"*address is required"}),this.city.extend({required:"*city is required"}),this.state.extend({required:"*state is required"})},this.changeMap=function(e){this.map.setCenter(e.geometry.location),this.map.setZoom(15);var t=this.parseAddress(e.address_components);this.currentLocation(new Location(t[0],t[1],t[2])),this.currentLocation().latlong=e.geometry.location,this.currentLocation().placeid=e.place_id,this.getZillowLocationId(),this.searchFacilities(),i.createLocationMarker(this.map)},this.newLocation=function(){var e=this.address()+", "+this.city()+", "+this.state();this.geocoder.geocode({address:e,componentRestrictions:{country:"US"}},function(e,t){"OK"===t&&(e.length>0?i.changeMap(e[0]):alert("Error: no results were found for your provided address."))})},this.parseAddress=function(i){for(var e=[],t="",o="",a="",n=0;n<i.length;n++)switch(!0){case"street_number"==i[n].types[0]:t+=i[n].short_name+" ";break;case"route"==i[n].types[0]:t+=i[n].short_name;break;case"locality"==i[n].types[0]:o=i[n].short_name;break;case"administrative_area_level_1"==i[n].types[0]:a=i[n].short_name}return e.push(t),e.push(o),e.push(a),e},this.searchFacilities=function(){this.currentFacilityList()&&this.currentFacilityList([]),this.bounds=new google.maps.LatLngBounds;for(var i=this.currentLocation().facilityCategoryList[0],e=1;e<this.currentLocation().facilityCategoryList.length;e++){var t=this.currentLocation().facilityCategoryList[e];this.service.nearbySearch({location:this.currentLocation().latlong,radius:4828.03,type:t.key},this.facilitiesCallback(t,i))}},this.facilitiesCallback=function(e,t){return function(o,a){if(a===google.maps.places.PlacesServiceStatus.OK){for(var n=0;n<o.length;n++){var s=new Facility(o[n],i.createFacilityMarker(o[n]));e.facilities.push(s),t.facilities.push(s)}i.map.fitBounds(i.bounds)}}},this.createFacilityMarker=function(e){var t=e.geometry.location,o=new google.maps.Marker({map:vmodel.map,icon:this.getIconData(e),title:e.name,position:t,id:e.place_id});return google.maps.event.addListener(o,"click",function(){i.goToFacility(o)}),e.geometry.viewport?this.bounds.union(e.geometry.viewport):this.bounds.extend(t),o},this.goToFacility=function(e){window.innerWidth<961&&$("#side_menu").hide(),e instanceof Facility&&(e=e.marker),i.map.setCenter(e.position),i.map.setZoom(15),e.setAnimation(google.maps.Animation.DROP),i.createFacilityInfoWindow(e)},this.goToLocation=function(){window.innerWidth<961&&$("#side_menu").hide(),this.map.getCenter()!==this.currentLocation().latlong&&(this.map.setCenter(this.currentLocation().latlong),this.map.setZoom(17)),this.locationMarker.setAnimation(google.maps.Animation.DROP),this.createLocationInfoWindow()},this.createFacilityInfoWindow=function(i){this.infowindow.setContent('<div class="info_window_container"><nav><ul class="nav nav-tabs"><li><a href="#" onclick="vmodel.getDetailsData(\''+i.id+'\');">details</a></li><li><a href="#" onclick="vmodel.getOpeningHours();">opening hours</li><li><a href="#" onclick="vmodel.getFoursquareTips();">reviews</a></li><li><a href="#"onclick="vmodel.getFoursquarePhotos();">photos</a></li></ul></nav><div id="info_window_body"><p>Fetching some cool stuff...</p><img src="img/110.gif"></div></div>'),this.getDetailsData(i.id),this.infowindow.open(i.map,i)},this.getDetailsData=function(e){this.service.getDetails({placeId:e},function(e,t){if(t===google.maps.places.PlacesServiceStatus.OK){i.showDistance(e.geometry.location),i.getVenueId(e.name,e.geometry.location.lat(),e.geometry.location.lng());var o=document.getElementById("info_window_body"),a={heading:"<h4>"+e.name+"</h4>",phone:e.formatted_phone_number?"<p><strong>Phone</strong>: "+e.formatted_phone_number+"</p>":"<p>No phone information available</p>",photo:e.photos?"<img src='"+e.photos[0].getUrl({maxWidth:150,maxHeight:150})+"' width='150px' height='150px'alt='location_image'>":"<img src='img/noimage.jpg' alt='location_image'>",address:e.formatted_address?"<p><em>"+e.formatted_address+"</em></p>":"<p><em>Sorry, no address available for this place</em></p>",ratings:e.reviews?"<p><strong>user rating</strong>: <span class='label label-info'>"+e.rating+"</label></p>":"<p>user rating: <span class='label label-info'>No reviews av.</label></p>",website:e.website?"<a href='"+e.website+"'>go to website</a>":"<span>No website available</span>",open_now:e.opening_hours?e.opening_hours.open_now?"<p>Open now: <span style='color: green;'>open</span></p>":"<p>Open now: <span style='color: red;'>closed</span></p>":"<p>Open now: Data not available</p>"};o.innerHTML=a.heading+a.address+'<div id="infowindow_card"><div id="infowindow_photo">'+a.photo+'</div><div id="infowindow_address">'+a.phone+a.ratings+"<p>"+a.website+'</p><p><strong>Distance</strong>: <span id="destination_distance"></span></p>'+a.open_now+"</div></div>",i.infowindow.heading=a.heading,e.opening_hours&&(i.infowindow.opening_hours=e.opening_hours)}})},this.createLocationInfoWindow=function(){this.infowindow.setContent(""),i.infowindow.setContent("<div class='info_window_container'><nav><ul class='nav nav-tabs'><li><a href='#' onclick='vmodel.getStreetView();'>street view</a></li><li><a href='#' onclick='vmodel.getZestimate();'>details</a></li></ul></nav><div id='streetview_container'><p>Fetching some cool stuff...</p><img src='img/110.gif'></div></div>"),this.getStreetView(),this.infowindow.open(this.map,this.locationMarker)},this.getStreetView=function(){this.streetViewService.getPanoramaByLocation(this.currentLocation().latlong,100,i.streetViewCallback)},this.streetViewCallback=function(e,t){if(t==google.maps.StreetViewStatus.OK){var o=e.location.latLng,a=google.maps.geometry.spherical.computeHeading(o,i.locationMarker.position);new google.maps.StreetViewPanorama(document.getElementById("streetview_container"),{position:o,pov:{heading:a,pitch:10}})}else i.infowindow.setContent("<div>Sorry, no street view available for this location.</div>")},this.getOpeningHours=function(){var i=document.getElementById("info_window_body"),e=this.infowindow.heading;if(this.infowindow.opening_hours){e+="<p><strong>Opening Schedule:</strong></p>",e+="<ul>";for(var t=0;t<this.infowindow.opening_hours.weekday_text.length;t++)e+="<li>"+this.infowindow.opening_hours.weekday_text[t]+"</li>";e+="</ul>"}else e+="<strong>No opening hours available</strong>";i.innerHTML=e},this.showDistance=function(i){var e=this.currentLocation().latlong,t=[i];this.distanceService.getDistanceMatrix({origins:[e],destinations:t,travelMode:"DRIVING",unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},function(i,e){if("OK"==e){var t=document.getElementById("destination_distance");t&&(t.innerHTML=i.rows[0].elements[0].distance.text)}})},this.filterMarkers=function(){for(var i=0;i<this.currentLocation().facilityCategoryList.length;i++){var e=this.currentLocation().facilityCategoryList[i];if(e.key!==this.currentFacilityList().key&&"all"!==this.currentFacilityList().key)for(var t=0;t<e.facilities().length;t++){e.facilities()[t].marker.setMap(null)}else for(var o=0;o<e.facilities().length;o++){var a=e.facilities()[o];a.marker.getMap()||a.marker.setMap(this.map)}}},this.createLocationMarker=function(e){this.locationMarker&&this.locationMarker.setMap(null);var t=new google.maps.Marker({map:e,title:this.currentLocation().addressline,position:this.currentLocation().latlong});this.locationMarker=t,google.maps.event.addListener(this.locationMarker,"click",function(){i.goToLocation()})},this.getIconData=function(i){return{url:i.icon,size:new google.maps.Size(35,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,34),scaledSize:new google.maps.Size(25,25)}},this.clearFields=function(){this.address(""),this.city(""),this.state("")},this.resetZoom=function(){window.innerWidth<961&&$("#side_menu").hide(),this.map.setCenter(this.currentLocation().latlong),this.map.setZoom(15),this.map.fitBounds(this.bounds)},this.getVenueId=function(e,t,o){var a="https://api.foursquare.com/v2/venues/search?v=20161016&ll="+t+","+o+"&query="+e+"&intent=match&client_id=G2CO0HDKUJAJMKRVLLSD2PAZ20MVMJJWRGAKUC3M4H20NJWV&client_secret=5NVLZB2BP2VFIHB1URO1AVRVECFLHYBPIGUKE0ISXU0AXEHB";$.ajax({url:a,success:function(e){i.infowindow.venue=e.response.venues.length>0&&e.response.venues[0].id}})},this.getFoursquareTips=function(){var e=document.getElementById("info_window_body"),t='<p>Fetching some cool stuff...</p><img src="img/110.gif">';if(this.infowindow.venue){var o="https://api.foursquare.com/v2/venues/"+this.infowindow.venue+"/tips?v=20161016&client_id=G2CO0HDKUJAJMKRVLLSD2PAZ20MVMJJWRGAKUC3M4H20NJWV&client_secret=5NVLZB2BP2VFIHB1URO1AVRVECFLHYBPIGUKE0ISXU0AXEHB";$.ajax({url:o,success:function(o){var a=o.response.tips.items;if(t=i.infowindow.heading,t+="<img src='img/foursquare.png'>",a.length>0)for(var n=0;n<a.length;n++)t+="<div class='well'>"+a[n].text+" -- <em>"+a[n].user.firstName+"</em></div>";else t+="No reviews found.";e.innerHTML=t}})}else t=i.infowindow.heading+"No foursquare data available",e.innerHTML=t},this.getFoursquarePhotos=function(){var i=document.getElementById("info_window_body"),e=this.infowindow.heading;if(this.infowindow.venue){var t="https://api.foursquare.com/v2/venues/"+this.infowindow.venue+"/photos?v=20161016&client_id=G2CO0HDKUJAJMKRVLLSD2PAZ20MVMJJWRGAKUC3M4H20NJWV&client_secret=5NVLZB2BP2VFIHB1URO1AVRVECFLHYBPIGUKE0ISXU0AXEHB";$.ajax({url:t,success:function(t){var o=t.response.photos.items;if(o.length>0){e+="<p><img src='img/foursquare.png'></p>",e+='<div class="container" id="carousel-container">',e+='<div id="infowindow_carousel" class="carousel slide">',e+='<div class="carousel-inner">';for(var a=0;a<o.length;a++)e+=0===a?'<div class="item active">':'<div class="item">',e+='<img class="thumbnail" src="'+o[a].prefix+"300x300"+o[a].suffix+'">',e+="</div>";e+="</div>",e+='<a class="left carousel-control" href="#infowindow_carousel" data-slide="prev"><span class="glyphicon glyphicon-chevron-left"></span></a>',e+='<a class="right carousel-control" href="#infowindow_carousel" data-slide="next"><span class="glyphicon glyphicon-chevron-right"></span></a>',e+="</div>",e+="</div>"}else e+="No photos found.";i.innerHTML=e}})}else e+="No foursquare photos available",i.innerHTML=e},this.getZillowLocationId=function(){$.ajax({url:"http://www.felipeboyd.com/webservices/zillow-zpid-service.php",data:{address:i.currentLocation().address,city:i.currentLocation().city,state:i.currentLocation().state},success:function(e,t){1==e?alert("No Zillow id found for this property. Please verify your address"):i.currentLocation().zpid=e}})},this.getZestimate=function(){this.currentLocation().zpid?$.ajax({url:"http://www.felipeboyd.com/webservices/zillow-zestimate-service.php",data:{zpid:this.currentLocation().zpid},success:function(e,t){i.parseZillowData(e),i.renderZillowData()}}):document.getElementById("streetview_container").innerHTML="<p>Sorry, Zillow information is not available for this address. Make sure this property is available on zillow</p>"},this.parseZillowData=function(i){var e=$.parseXML(i),t=$(e).find("zestimate");this.currentLocation().z_dollar_amount=t.find("amount").text(),this.currentLocation().z_last_updated=t.find("last-updated").text(),this.currentLocation().z_value_change=t.find("valueChange").text(),this.currentLocation().z_value_low=t.find("low").text(),this.currentLocation().z_value_high=t.find("high").text(),this.currentLocation().z_value_duration=t.find("valueChange").attr("duration")},this.renderZillowData=function(){var i=document.getElementById("streetview_container");i.removeAttribute("jstcache"),i.removeAttribute("style"),i.innerHTML='<h4>Zillow Data</h4><ul class="list_group"><li class="list-group-item"><b>Amount(USD):</b> '+this.currentLocation().z_dollar_amount+'</li><li class="list-group-item"><b>Last Price Update:</b> '+this.currentLocation().z_last_updated+'</li><li class="list-group-item"><b>Change in Value:</b> '+this.currentLocation().z_value_change+" ("+this.currentLocation().z_value_duration+' days)</li><li class="list-group-item"><b>High:</b> '+this.currentLocation().z_value_high+'</li><li class="list-group-item"><b>Low:</b> '+this.currentLocation().z_value_low+"</li></ul><p>Data fetched from www.zellow.com</p>"}};ko.extenders.required=function(i,e){function t(t){i.hasError(!t),i.validationMessage(t?"":e||"This field is required")}return i.hasError=ko.observable(),i.validationMessage=ko.observable(),t(i()),i.subscribe(t),i},vmodel=new ViewModel,vmodel.init(),ko.applyBindings(vmodel),$("#hamburger").click(function(){$("#side_menu").slideToggle()});